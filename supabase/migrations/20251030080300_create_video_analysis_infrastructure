-- 1. Créer le bucket de stockage pour les vidéos d'analyse
-- On le rend public pour la lecture, mais on restreindra l'écriture via les policies.
INSERT INTO storage.buckets (id, name, public)
VALUES ('video_analysis', 'video_analysis', true)
ON CONFLICT (id) DO NOTHING;

-- Policies pour le bucket video_analysis
-- Permettre aux utilisateurs authentifiés de téléverser des vidéos
CREATE POLICY "authenticated_upload" ON storage.objects
FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'video_analysis');

-- Permettre à tous de lire les vidéos (nécessaire pour l'affichage dans l'app)
CREATE POLICY "public_read" ON storage.objects
FOR SELECT
USING (bucket_id = 'video_analysis');


-- 2. Créer la table pour stocker les résultats des analyses vidéo
CREATE TABLE IF NOT EXISTS public.video_analyses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    
    video_path TEXT NOT NULL, -- Chemin vers la vidéo dans le bucket 'video_analysis'
    movement_type TEXT NOT NULL, -- ex: 'squat', 'sprint'
    
    -- Le rapport d'analyse sera stocké en JSON
    analysis_report JSONB,
    
    -- Statut global de l'exécution
    overall_status TEXT, -- ex: 'Bonne exécution', 'Exécution à améliorer'
    
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES auth.users(id)
);

-- Activer la sécurité au niveau des lignes pour la nouvelle table
ALTER TABLE public.video_analyses ENABLE ROW LEVEL SECURITY;

-- Policies pour la table video_analyses
-- Les utilisateurs peuvent créer leurs propres analyses
CREATE POLICY "user_can_create_own_analysis" ON public.video_analyses
FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

-- Les utilisateurs ne peuvent voir que leurs propres analyses
CREATE POLICY "user_can_see_own_analyses" ON public.video_analyses
FOR SELECT TO authenticated
USING (auth.uid() = user_id);

-- Ajouter des commentaires sur les colonnes pour la clarté
COMMENT ON COLUMN public.video_analyses.video_path IS 'Chemin vers la vidéo dans le bucket Supabase Storage (video_analysis)';
COMMENT ON COLUMN public.video_analyses.analysis_report IS 'Rapport détaillé au format JSON, ex: {"profondeur": "atteinte", "dos": "arrondi"}';
